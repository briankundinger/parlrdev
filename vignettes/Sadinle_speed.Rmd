---
title: "Sadinle_speed"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sadinle_speed}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
devtools::load_all()
library(parlrdev)
library(tidyverse)
```


```{r}

n1_vals <- c(100, 500, 1000, 2000, 3000)
n2_vals <- c(100, 500, 1000, 2000, 3000)
show_progress <- T
fast = F

m <- c(.05, .95, .05, .95, .05, .95, .05, .95, .05, .95)

u <- c(.99, .01, .99, .01, 
       1 - 1/30, 1/30, 1 - 1/12, 1/12, 1 - 1/15, 1/15)


levels <- c(2, 2, 2, 2, 2)


# S <- 1000; burn <- S * .1
# m_prior <- u_prior <- rep(1, length(m))
# alpha <- beta <- 1
results_bk_samps <- matrix(NA, nrow = length(n1_vals), ncol = 4)
results_sad_samps <- matrix(NA, nrow = length(n1_vals), ncol = 4)

for(i in seq_len(n1_vals)){
  
  #Simulate Data
  n1 <- n1_vals[i]
  n2 <- n2_vals[i]
  overlap <- n2/2
  cd <- SimulateComparisons(m, u, levels, n1, n2, overlap)
  Ztrue <- cd$Ztrue
  
  #parlr method
  ptm <- proc.time()
  Zchain <- BKSimple_hash2(cd)
  elapsed <- proc.time() - ptm
  Zhat <- BRL::linkRecords(Zchain, n1, 1, 1, 2, Inf)
  eval <- GetEvaluations(Zhat, Ztrue, n1)
  results_bk_samps[i, ] <- c(eval, elapsed[3])
  
  #Sadinle 2017 Method
  ptm <- proc.time()
  Zchain <- BRL::bipartiteGibbs(cd)
  elapsed <- proc.time() - ptm
  Zhat <- BRL::linkRecords(Zchain[[1]], n1, 1, 1, 2, Inf)
  eval <- GetEvaluations(Zhat, Ztrue, n1)
  results_sad_samps[i,] <- c(eval, elapsed[3])
  
  print(i)
}

list(BK = results_bk_samps,
     Sadinle = results_sad_samps)
```

```{r}



parlr_df <- data.frame(results_bk_samps, n2_vals, "parlr")
names(parlr_df) <- c("recall", "precision", "fmeasure", "time", "n", "method")
sadinle_df <- data.frame(results_sad_samps, n2_vals, "sadinle")
names(sadinle_df) <- c("recall", "precision", "fmeasure", "time", "n",  "method")

df<- rbind(parlr_df, sadinle_df)

speed_plot <- df %>% 
  ggplot(aes(x = n, y = time, color = method)) +
  geom_line(size = 1) +
  labs(x = "Size of each dataset",
       y = "Time (seconds)",
       color = "Method", 
       title = "Speed Comparison: parlr and Sadinle 17",
       subtitle = "1000 Gibbs iterations") +
  theme_bw() +
  theme(plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5))

ggsave(filename = "../notes/figures/speed_plot.png",
       plot = speed_plot)
# results_df <- df %>% 
#   pivot_longer(cols = 1:4, names_to = "metric") %>% 
#   group_by(method, metric) %>% 
#   summarize(avg = mean(value),
#             lower = quantile(value, .2),
#             upper = quantile(value, .8),
#             .groups = "drop")
#results_df
# simple_dist_table <- results_df %>%
#   kable(digits = 3,
#         caption = "Results for Simpler Distributions (Full)") %>%
#   kable_classic() %>%
#   kable_styling(full_width = F)
  #as_image(file = "../notes/figures/simple_dist_table.png")
```

